variables:
  amrwind_exe: &amrwind_exe 'amr-wind+rocm+tiny_profile+gpu-aware-mpi'
  amrwind_input_file: &amrwind_input_file '/lustre/orion/cfd116/proj-shared/marchdf/amrwind-scaling/abl_godunov_wenoz.inp'

job_set:
  name: amrwind-frontier-weak-scaling
  email: marc.henrydefrahan@nrel.gov
  mail_type: NONE
  project_allocation: CFD116
  notes: AMR-Wind Frontier weak scaling study for ABL case
  spack_manager: '${HOME}/exawind/spack-manager'
  job_list:
    # finding the number of cells per gpu limit
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: debug, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 1, awind_ranks: 8, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=256 256 256 geometry.prob_hi=1000. 1000. 1000. time.fixed_dt=0.02 time.max_step=50 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 1, awind_ranks: 8, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=512 256 256 geometry.prob_hi=2000. 1000. 1000. time.fixed_dt=0.02 time.max_step=50 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 1, awind_ranks: 8, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=512 512 256 geometry.prob_hi=2000. 2000. 1000. time.fixed_dt=0.02 time.max_step=50 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 1, awind_ranks: 8, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=1024 512 256 geometry.prob_hi=4000. 2000. 1000. time.fixed_dt=0.02 time.max_step=50 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 1, awind_ranks: 8, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=1024 1024 256 geometry.prob_hi=4000. 4000. 1000. time.fixed_dt=0.02 time.max_step=50 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 1, awind_ranks: 8, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=2048 1024 256 geometry.prob_hi=8000. 4000. 1000. time.fixed_dt=0.02 time.max_step=50 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 1, awind_ranks: 8, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=2048 2048 256 geometry.prob_hi=8000. 8000. 1000. time.fixed_dt=0.02 time.max_step=50 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    #
    # Weak scaling
    #
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 1, awind_ranks: 8, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=1024 1024 256 geometry.prob_hi=4000. 4000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 2, awind_ranks: 16, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=2048 1024 256 geometry.prob_hi=8000. 4000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 4, awind_ranks: 32, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=2048 2048 256 geometry.prob_hi=8000. 8000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 8, awind_ranks: 64, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=4096 2048 256 geometry.prob_hi=16000. 8000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 16, awind_ranks: 128, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=4096 4096 256 geometry.prob_hi=16000. 16000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 32, awind_ranks: 256, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=8192 4096 256 geometry.prob_hi=32000. 16000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 64, awind_ranks: 512, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=8192 8192 256 geometry.prob_hi=32000. 32000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 128, awind_ranks: 1024, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=16384 8192 256 geometry.prob_hi=64000. 32000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 256, awind_ranks: 2048, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=16384 16384 256 geometry.prob_hi=64000. 64000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 512, awind_ranks: 4096, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=32768 16384 256 geometry.prob_hi=128000. 64000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 60, nodes: 1024, awind_ranks: 8192, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=32768 32768 256 geometry.prob_hi=128000. 128000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 60, nodes: 2048, awind_ranks: 16384, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=65536 32768 256 geometry.prob_hi=256000. 128000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 60, nodes: 4096, awind_ranks: 32768, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=65536 65536 256 geometry.prob_hi=256000. 256000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    # - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 60, nodes: 8192, awind_ranks: 65536, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=131072 65536 256 geometry.prob_hi=512000. 256000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=64 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    #
    # Weak scaling different max grid
    #
    - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 1, awind_ranks: 8, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=1024 1024 256 geometry.prob_hi=4000. 4000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=128 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 2, awind_ranks: 16, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=2048 1024 256 geometry.prob_hi=8000. 4000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=128 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 4, awind_ranks: 32, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=2048 2048 256 geometry.prob_hi=8000. 8000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=128 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 8, awind_ranks: 64, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=4096 2048 256 geometry.prob_hi=16000. 8000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=128 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 16, awind_ranks: 128, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=4096 4096 256 geometry.prob_hi=16000. 16000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=128 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 32, awind_ranks: 256, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=8192 4096 256 geometry.prob_hi=32000. 16000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=128 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 64, awind_ranks: 512, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=8192 8192 256 geometry.prob_hi=32000. 32000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=128 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 128, awind_ranks: 1024, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=16384 8192 256 geometry.prob_hi=64000. 32000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=128 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 256, awind_ranks: 2048, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=16384 16384 256 geometry.prob_hi=64000. 64000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=128 amrex.use_profiler_syncs=0 amrex.async_out=0'}
    - {executable: *amrwind_exe, input_file: *amrwind_input_file, files_to_copy: [], mesh:, queue: batch, mapping: amrwind-all-gpu, compiler: gcc, minutes: 30, nodes: 512, awind_ranks: 4096, nwind_ranks: 0, pre_args:, post_args: 'amr.n_cell=32768 16384 256 geometry.prob_hi=128000. 64000. 1000. time.fixed_dt=0.02 time.max_step=5 time.plot_interval=-1 time.checkpoint_interval=-1 amrex.abort_on_out_of_gpu_memory=1 amrex.the_arena_is_managed=0 amr.blocking_factor=16 amr.max_grid_size=128 amrex.use_profiler_syncs=0 amrex.async_out=0'}
